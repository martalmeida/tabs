"undefined"!=typeof L&&(L.WebGLVectorLayer=L.Class.extend({includes:[L.Mixin.Events,L.Mixin.TileLoader],options:{},initialize:function(a){a=a||{},this.render=this.render.bind(this),L.Util.setOptions(this,a),this._canvas=this._createCanvas();var c=this._canvas;this._ctx=c.getContext("experimental-webgl",{antialias:!0}),this._backCanvas=this._createCanvas(),this.currentAnimationFrame=-1,this.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)},this.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame||function(a){clearTimeout(a)};var d=this._ctx,e=d.createShader(d.VERTEX_SHADER);d.shaderSource(e,document.getElementById("vshader").text),d.compileShader(e);var f=d.createShader(d.FRAGMENT_SHADER);d.shaderSource(f,document.getElementById("fshader").text),d.compileShader(f);var g=d.createProgram();d.attachShader(g,e),d.attachShader(g,f),d.linkProgram(g),d.useProgram(g),this._u_matLoc=d.getUniformLocation(g,"u_matrix"),this._u_paletteFactorLoc=d.getUniformLocation(g,"u_paletteFactor"),this._vertLoc=d.getAttribLocation(g,"a_vertex"),this._colorLoc=d.getAttribLocation(g,"a_color"),this.palette=new Uint8Array([255,255,255,255,114,247,173,255,113,247,135,255,112,245,95,255,112,245,56,255,116,246,47,255,134,246,49,255,159,246,51,255,187,248,53,255,217,246,56,255,246,250,59,255,250,225,56,255,245,190,49,255,241,155,44,255,238,118,39,255,236,82,35,255,235,59,34,255,139,0,0,255,128,0,0,255,78,0,0,255,35,0,0,255,0,0,0,255,0,34,102,255]),this.paletteSize=this.palette.length/4,d.uniform1f(this._u_paletteFactorLoc,1/this.paletteSize),this.paletteTexture=d.createTexture(),d.bindTexture(d.TEXTURE_2D,this.paletteTexture),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,this.paletteSize,1,0,d.RGBA,d.UNSIGNED_BYTE,this.palette),this._pixelsToWebGLMatrix=new Float32Array(16),this._mapMatrix=new Float32Array(16)},allocateBuffers:function(a){var b=this._numPoints;if(this._numPoints=2*a,!(this._numPoints<=b)){var c=this._ctx;this.vertArray=new Float32Array(2*this._numPoints),this.vertBuffer=c.createBuffer(),c.enableVertexAttribArray(this._vertLoc),c.bindBuffer(c.ARRAY_BUFFER,this.vertBuffer),c.vertexAttribPointer(this._vertLoc,2,c.FLOAT,!1,0,0),this.colorArray=new Uint8Array(this._numPoints),this.colorBuffer=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,this.colorBuffer),c.enableVertexAttribArray(this._colorLoc),c.vertexAttribPointer(this._colorLoc,1,c.UNSIGNED_BYTE,!1,0,0)}},_createCanvas:function(){var a;a=document.createElement("canvas"),a.style.position="absolute",a.style.top=0,a.style.left=0,a.style.pointerEvents="none",a.style.zIndex=this.options.zIndex||0;var b="leaflet-tile-container leaflet-zoom-animated";return a.setAttribute("class",b),a},onAdd:function(a){this._map=a;var b=this._map._panes.tilePane,c=L.DomUtil.create("div","leaflet-layer");c.appendChild(this._canvas),c.appendChild(this._backCanvas),this._backCanvas.style.display="none",b.appendChild(c),this._container=c,a.dragging.enabled()&&a.dragging._draggable.on("predrag",function(){var b=a.dragging._draggable;L.DomUtil.setPosition(this._canvas,{x:-b._newPos.x,y:-b._newPos.y})},this),a.on({viewreset:this._reset,move:this.redraw,resize:this._reset,zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.tileLoader&&this._initTileLoader(),this._reset()},_animateZoom:function(){},_endZoomAnim:function(){},latLongToPixelXY:function(a,b){var c=Math.PI/180,d=4*Math.PI,e=Math.sin(a*c),f=256*(.5-Math.log((1+e)/(1-e))/d),g=(b+180)/360*256,h={x:g,y:f};return h},distanceBetwPixelToColor:function(a,b){var c=Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2));return c},translateMatrix:function(a,b,c){a[12]+=a[0]*b+a[4]*c,a[13]+=a[1]*b+a[5]*c,a[14]+=a[2]*b+a[6]*c,a[15]+=a[3]*b+a[7]*c},scaleMatrix:function(a,b,c){a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,a[4]*=c,a[5]*=c,a[6]*=c,a[7]*=c},randomInt:function(a){return Math.floor(Math.random()*a)},setLines:function(a,b,c){this.allocateBuffers(a.length);var d=0,e=0;b=b||{};for(var f=25,g=mapView.map.getZoom(),h=mapView.minZoom,i=Math.pow(2,g-h),j=0;j<a.length;j+=3){var k=this.latLongToPixelXY(a[j][0][0],a[j][0][1]),l=this.latLongToPixelXY(a[j][1][0],a[j][1][1]),m=this.latLongToPixelXY(a[j+1][0][0],a[j+1][0][1]),n=this.latLongToPixelXY(a[j+1][1][0],a[j+1][1][1]),o=this.latLongToPixelXY(a[j+2][0][0],a[j+2][0][1]),p=this.latLongToPixelXY(a[j+2][1][0],a[j+2][1][1]),q="wind"==c?21:"radar"==c?5:Math.floor(f*i*this.distanceBetwPixelToColor(o,p));this.vertArray[d++]=k.x,this.vertArray[d++]=k.y,this.colorArray[e++]=q,this.vertArray[d++]=l.x,this.vertArray[d++]=l.y,this.colorArray[e++]=q,this.vertArray[d++]=m.x,this.vertArray[d++]=m.y,this.colorArray[e++]=q,this.vertArray[d++]=n.x,this.vertArray[d++]=n.y,this.colorArray[e++]=q,this.vertArray[d++]=o.x,this.vertArray[d++]=o.y,this.colorArray[e++]=q,this.vertArray[d++]=p.x,this.vertArray[d++]=p.y,this.colorArray[e++]=q}var r=this._ctx;r.bindBuffer(r.ARRAY_BUFFER,this.vertBuffer),r.bufferData(r.ARRAY_BUFFER,this.vertArray,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferData(r.ARRAY_BUFFER,this.colorArray,r.STATIC_DRAW),this.redraw()},setLines2D:function(a,b,c){this.allocateBuffers(8*a.length/3);var d=0,e=0;b=b||{};for(var f=25,g=mapView.map.getZoom(),h=mapView.minZoom,i=Math.pow(2,g-h),j="buoys"==c?.75:2/3,k="buoys"==c?.02:1/3,l="buoys"==c?0:1/3,m="buoys"==c?Math.PI/6:Math.PI/4,n=0;n<a.length;n+=3){var o=this.latLongToPixelXY(a[n+2][1][0],a[n+2][1][1]),p=this.latLongToPixelXY(a[n+2][0][0],a[n+2][0][1]),q=norm2(o,p);if(q>0)var r={x:p.x-o.x,y:p.y-o.y},s=prodScalar(r,1/q),t=somVect(o,prodScalar(s,j*q)),u=0==r.y?Math.PI/2:Math.atan(-r.x/r.y),v={x:Math.cos(u),y:Math.sin(u)},w=norm2(p,t)*Math.tan(m),x=somVect(t,prodScalar(v,w)),y=somVect(t,prodScalar(v,-w)),z=somVect(o,prodScalar(v,w*k)),A=l*norm(somVect(p,prodScalar(t,-1))),B=A/w*(w-norm(somVect(z,prodScalar(o,-1)))),C=somVect(o,prodScalar(v,-w*k)),D=somVect(z,prodScalar(s,j*q+B)),E=somVect(C,prodScalar(s,j*q+B));var J=(this.latLongToPixelXY(a[n][0][0],a[n][0][1]),this.latLongToPixelXY(a[n][1][0],a[n][1][1]),this.latLongToPixelXY(a[n+1][0][0],a[n+1][0][1]),this.latLongToPixelXY(a[n+1][1][0],a[n+1][1][1]),this.latLongToPixelXY(a[n+2][0][0],a[n+2][0][1])),K=this.latLongToPixelXY(a[n+2][1][0],a[n+2][1][1]);"wind"==c?21:"buoys"==c?16:Math.floor(f*i*this.distanceBetwPixelToColor(J,K));this.vertArray[d++]=o.x,this.vertArray[d++]=o.y,this.colorArray[e++]=22,this.vertArray[d++]=z.x,this.vertArray[d++]=z.y,this.colorArray[e++]=22,this.vertArray[d++]=z.x,this.vertArray[d++]=z.y,this.colorArray[e++]=22,this.vertArray[d++]=D.x,this.vertArray[d++]=D.y,this.colorArray[e++]=22,this.vertArray[d++]=D.x,this.vertArray[d++]=D.y,this.colorArray[e++]=22,this.vertArray[d++]=x.x,this.vertArray[d++]=x.y,this.colorArray[e++]=22,this.vertArray[d++]=x.x,this.vertArray[d++]=x.y,this.colorArray[e++]=22,this.vertArray[d++]=p.x,this.vertArray[d++]=p.y,this.colorArray[e++]=22,this.vertArray[d++]=p.x,this.vertArray[d++]=p.y,this.colorArray[e++]=22,this.vertArray[d++]=y.x,this.vertArray[d++]=y.y,this.colorArray[e++]=22,this.vertArray[d++]=y.x,this.vertArray[d++]=y.y,this.colorArray[e++]=22,this.vertArray[d++]=E.x,this.vertArray[d++]=E.y,this.colorArray[e++]=22,this.vertArray[d++]=E.x,this.vertArray[d++]=E.y,this.colorArray[e++]=22,this.vertArray[d++]=C.x,this.vertArray[d++]=C.y,this.colorArray[e++]=22,this.vertArray[d++]=C.x,this.vertArray[d++]=C.y,this.colorArray[e++]=22,this.vertArray[d++]=o.x,this.vertArray[d++]=o.y,this.colorArray[e++]=22}var M=this._ctx;M.bindBuffer(M.ARRAY_BUFFER,this.vertBuffer),M.bufferData(M.ARRAY_BUFFER,this.vertArray,M.STATIC_DRAW),M.bindBuffer(M.ARRAY_BUFFER,this.colorBuffer),M.bufferData(M.ARRAY_BUFFER,this.colorArray,M.STATIC_DRAW),this.redraw()},getCanvas:function(){return this._canvas},draw:function(){return this._reset()},onRemove:function(a){this._container.parentNode.removeChild(this._container),a.off({viewreset:this._reset,move:this._render,resize:this._reset,zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this)},addTo:function(a){return a.addLayer(this),this},setOpacity:function(a){return this.options.opacity=a,this._updateOpacity(),this},setZIndex:function(a){this._canvas.style.zIndex=a},bringToFront:function(){return this},bringToBack:function(){return this},_reset:function(){var a=this._map.getSize();this._canvas.width=a.x,this._canvas.height=a.y;var b=L.DomUtil.getPosition(this._map.getPanes().mapPane);b&&L.DomUtil.setPosition(this._canvas,{x:-b.x,y:-b.y}),this.onResize(),this._render()},_updateOpacity:function(){},_render:function(){this.currentAnimationFrame>=0&&this.cancelAnimationFrame.call(window,this.currentAnimationFrame),this.currentAnimationFrame=this.requestAnimationFrame.call(window,this.render)},redraw:function(a){if(void 0!==this._map){var b=L.DomUtil.getPosition(this._map.getPanes().mapPane);b&&L.DomUtil.setPosition(this._canvas,{x:-b.x,y:-b.y}),a?this.render():this._render()}},onResize:function(){var a=this._ctx,b=this.getCanvas(),c=b.clientWidth,d=b.clientHeight;this._pixelsToWebGLMatrix.set([2/c,0,0,0,0,-2/d,0,0,0,0,0,0,-1,1,0,1]),a.viewport(0,0,c,d)},render:function(){var a=this._ctx;if(null!==a){a.clear(a.COLOR_BUFFER_BIT),this._mapMatrix.set(this._pixelsToWebGLMatrix);var b=this._map.getBounds(),c=new L.LatLng(b.getNorth(),b.getWest()),d=this.latLongToPixelXY(c.lat,c.lng),e=Math.pow(2,this._map.getZoom());this.scaleMatrix(this._mapMatrix,e,e),this.translateMatrix(this._mapMatrix,-d.x,-d.y),a.uniformMatrix4fv(this._u_matLoc,!1,this._mapMatrix),a.drawArrays(a.LINES,0,this._numPoints)}}}));