MapView=function(a,b,c,d){function j(a,b,c,d){function e(e){e.layer===c&&(a.visibleLayers[b]=d,a.redraw())}return e}function k(a){var b=[a.getUTCDate().padLeft(),d.monthStrings[a.getUTCMonth()],a.getFullYear()].join(" "),c=[a.getHours().padLeft(),a.getMinutes().padLeft()].join(":");return b+" "+c+" UTC"}var e=0,f=1,g=2,h={visibleLayers:d.visibleLayers,delay:d.delay,runState:e,dataSource:"hindcast",nFrames:d.nFrames,minZoom:d.minZoom,defaultZoom:d.defaultZoom,maxZoom:d.maxZoom,mapCenter:d.mapCenter,tileLayerURL:d.tileLayerURL,attribution:"© <a href='https://www.mapbox.com/map-feedback/'>Mapbox</a> © <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap contributors</a>",domainURL:d.domainURL},i=function(g){var i=this;a.extend(i,h,g),i.currentFrame=0,i.queuedFrame=0;var l=b.tileLayer(i.tileLayerURL,{attribution:i.attribution,maxZoom:i.maxZoom,minZoom:i.minZoom});i.map=b.map("map",{center:i.mapCenter,zoom:i.defaultZoom,layers:[l],fullscreenControl:!0}),i.map.on("viewreset",function(){i.runState===e&&i.redraw()}),i.tabsControl=new TABSControl.tabsControl({nFrames:i.nFrames,onclick:function(){i.toggleRunState()}}),i.tabsControl.addTo(i.map),b.Control.Toggle=b.Control.extend({options:{position:"topright",onclick:function(){i.changeDataSource()}},onAdd:function(a){var c=this;this._map=a;var d=["tabs-control","leaflet-control-attribution","leaflet-control"].join(" ");return this.container=b.DomUtil.create("div",d),this.updateText(),b.DomEvent.on(this.container,"click",function(a){b.DomEvent.stopPropagation(a),c.options.onclick(a),c.updateText(a),c.updateSideBar(a)}),this.container},updateText:function(){console.log("Switch data source to",i.dataSource),i.dataSourceButton.container.innerHTML='<img src="js/external/leaflet/images/databases.png" alt="Source"/> '+i.dataSource},updateSideBar:function(){a("#sidebar").toggle(),console.log("SideBar is","block"===a("#sidebar").css("display")?"visible":"hidden")}}),i.dataSourceButton=new b.Control.Toggle,i.dataSourceButton.addTo(i.map),i.sliderControl=b.control.sliderControl({minValue:0,maxValue:i.nFrames,slide:function(a,b){i.queueFrame(b.value),i.start(f)},renderValue:function(a){var b=1e3*i.timestamps[a];return k(new Date(b))}}),i.map.addControl(i.sliderControl),i.sliderControl.startSlider(),i.distanceScaleControl=b.control.scale(d.distanceScaleOptions).addTo(i.map);var n=(b.control.sidebar("sidebar",{position:"left"}).addTo(i.map),b.marker([25.61,-96.02]).bindPopup("Buoy 1")),o=b.marker([28.74,-92.99]).bindPopup("Buoy 2"),p=b.marker([28.73,-89.8]).bindPopup("Buoy 3"),q=b.marker([27.77,-94.23]).bindPopup("Buoy 4"),s=(b.layerGroup([n,o,p,q]),b.tileLayer("",{id:"EmptyMap",minZoom:d.minZoom,maxZoom:d.maxZoom})),t={None:s},u={};lsc=i.layerSelectControl=b.control.layers(t,u,{position:"topleft"}).addTo(i.map),lsc.addToggledOverlay=function(b,c,d){switch(d.toLowerCase()){case"salinity":case"temperature":case"speed":lsc.addBaseLayer(c,d);break;default:lsc.addOverlay(c,d)}i.map.on("overlayadd",j(i,b,c,!0)),i.map.on("overlayremove",j(i,b,c,!1))};var v={datasource:i.dataSource};API.withFrameTimestamps(v,function(a){i.timestamps=a.timestamps}),d.enableWind&&(i.windView=WindView.windView(g).addTo(i)),d.enableVelocity&&(i.velocityView=VelocityView.velocityView(g).addTo(i)),d.enableRadar&&(i.radarView=RadarView.radarView(g).addTo(i)),d.enableSalinity&&(i.saltView=SaltView.saltView(g).addTo(i)),d.enableTemperature&&(i.temperatureView=TemperatureView.temperatureView(g).addTo(i)),d.enableSpeed&&(i.speedView=SpeedView.speedView(g).addTo(i)),d.enableBuoys&&(i.buoysView=BuoysView.buoysView(g).addTo(i)),i.redraw(),window.onkeypress=function(b){32===b.charCode&&i.toggleRunState()}};return i.prototype.toggleRunState=function(){var b=this;b.runState!==g?b.start(g):b.start(f)},i.prototype.changeDataSource=function(){var b=this;"hindcast"!==b.dataSource?b.dataSource="hindcast":b.dataSource="forecast",b.queueFrame(0),b.start(f),b.velocityView.clearCache();var c={datasource:b.dataSource};API.withFrameTimestamps(c,function(a){b.timestamps=a.timestamps,b.nFrames=b.timestamps.length,b.tabsControl.nFrames=b.nFrames}),b.currentFrame=0,b.visibleLayers.velocity&&(b.velocityView&&b.velocityView.resetGrid(),b.redraw())},i.prototype.queueFrame=function(b){var c=this,d=void 0===b?(c.currentFrame+1)%c.nFrames:b;c.queuedFrame=d},i.prototype.mapScale=function(){var b=this,c=.5,d=b.map.getZoom();return c*Math.pow(2,b.defaultZoom-d)},i.prototype.addRegionOutline=function(){var c=this;b.mapbox.featureLayer().loadURL(c.domainURL).on("ready",function(a){this.eachLayer(function(a){a.setStyle({color:"red",fill:!1})})}).addTo(c.map)},i.prototype.showTimeStep=function(c,d){var e=this;e.currentFrame=c,e.sliderControl.value(c),b.Util.requestAnimFrame(function(){this.redraw(d)},e,!0)},i.prototype.start=function(b){var c=this,d=c.runState;c.runState=void 0===b?g:b,d===e&&c._run()},i.prototype._dirty=function(){var b=this;return b.currentFrame!==b.queuedFrame},i.prototype._run=function(){var b=this;if(b.runState!==e){var c=Date.now();b.showTimeStep(b.queuedFrame,function(){var a;a=b._dirty()?0:Math.max(0,c-Date.now()+b.delay);var d=b.currentFrame%showFPS===0;if(showFPS&&b.runState===g&&d){var e=(showFPS/((c-b.t)/1e3)).toFixed(2)+" FPS",f=a.toFixed(0)+"/"+b.delay+"ms";console.log(e+"\tdelay: "+f),b.t=c}b._dirty()||(b.runState===g?b.queueFrame():b.stop()),setTimeout(b._run.bind(b),a)})}},i.prototype.stop=function(){var b=this;b.runState=e},i.prototype.redraw=function(c){var e=this,f=a("input[class=leaflet-control-layers-selector]:checked").parent().text().toLowerCase();if(e.visibleLayers.velocity&&f.indexOf("velocity")>=0&&e.velocityView&&e.velocityView.redraw(function(b){e.tabsControl&&e.tabsControl.updateInfo({frame:e.currentFrame,date:b.date}),c&&c(b)}),e.visibleLayers.wind&&f.indexOf("wind")>=0&&e.windView&&e.windView.redraw(function(b){e.tabsControl&&e.tabsControl.updateInfo({frame:e.currentFrame,date:b.date}),c&&c(b)}),e.visibleLayers.buoys&&f.indexOf("buoys")>=0)e.buoysView&&e.buoysView.redraw(function(b){e.tabsControl&&e.tabsControl.updateInfo({frame:e.currentFrame,date:b.date}),c&&c(b)});else if(0!=d.buoysMarkers.length){for(var g=0;g<d.buoysMarkers.length;g++)e.map.removeLayer(d.buoysMarkers[g]);d.buoysMarkers=[]}e.visibleLayers.salinity&&f.indexOf("salinity")>=0?(e.saltView&&e.saltView.redraw(function(b){e.tabsControl&&e.tabsControl.updateInfo({frame:e.currentFrame,date:b.date,numSaltLevels:e.saltView.numSaltLevels}),c&&c(b)}),a("#salinity_legend").show()):a("#salinity_legend").hide(),e.visibleLayers.temperature&&f.indexOf("temperature")>=0?(e.temperatureView&&e.temperatureView.redraw(function(b){e.tabsControl&&e.tabsControl.updateInfo({frame:e.currentFrame,date:b.date,numTemperatureLevels:e.temperatureView.numTemperatureLevels}),c&&c(b)}),a("#temperature_legend").show()):a("#temperature_legend").hide(),e.visibleLayers.radar&&f.indexOf("radar")>=0&&e.radarView&&e.radarView.redraw(function(b){e.tabsControl&&e.tabsControl.updateInfo({frame:e.currentFrame,date:b.date}),c&&c(b)}),e.visibleLayers.speed&&f.indexOf("speed")>=0?(e.speedView&&e.speedView.redraw(function(b){e.tabsControl&&e.tabsControl.updateInfo({frame:e.currentFrame,date:b.date}),c&&c(b)}),a("#speed_legend").show()):a("#speed_legend").hide(),e.visibleLayers.none&&f.indexOf("none")>=0&&(e.minZoom=d.minZoom,e.maxZoom=d.maxZoom,e.noneView&&e.noneView.redraw())},{mapView:function(b){return new i(b)}}}(jQuery,L,Models,Config);